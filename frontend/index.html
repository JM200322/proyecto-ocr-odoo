<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta OCR para Odoo - Precisi√≥n M√°xima</title>
    
    <!-- Cargar Tesseract.js desde m√∫ltiples CDNs para m√°xima confiabilidad -->
    <script>
        // Funci√≥n para cargar Tesseract.js con fallbacks
        async function loadTesseract() {
            const cdns = [
                'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js',
                'https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js',
                'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js'
            ];
            
            for (const cdn of cdns) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = cdn;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    
                    if (typeof Tesseract !== 'undefined') {
                        console.log(`Tesseract.js cargado desde: ${cdn}`);
                        return true;
                    }
                } catch (error) {
                    console.warn(`Error cargando desde ${cdn}:`, error);
                }
            }
            return false;
        }
        
        // Cargar Tesseract al inicio
        loadTesseract().then(loaded => {
            if (!loaded) {
                document.addEventListener('DOMContentLoaded', () => {
                    showStatus('error', '‚ùå Error: No se pudo cargar Tesseract.js. Verifica tu conexi√≥n a internet.');
                });
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2f855a;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #2d3748;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: #f7fafc;
            border-radius: 12px;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid #38a169;
            border-radius: 12px;
            background: rgba(56, 161, 105, 0.1);
        }

        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
            border: 2px solid #90cdf4;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .text-area {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 15px;
        }

        .text-area:focus {
            outline: none;
            border-color: #667eea;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #fc8181 0%, #f6e05e 50%, #68d391 100%);
            transition: width 0.3s;
        }

        .flash-effect {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .progress-container {
            background: #f7fafc;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #4a5568;
            margin-top: 5px;
        }

        .image-preview {
            display: none;
            margin: 15px 0;
        }

        .image-preview img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                padding: 15px;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .camera-controls {
                grid-template-columns: 1fr;
            }
        }

        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #4a5568;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± OCR Ultra-Preciso</h1>
            <p>Extracci√≥n de texto con 100% precisi√≥n</p>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="docsProcessed">0</div>
                <div class="stat-label">Procesados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgConfidence">0%</div>
                <div class="stat-label">Confianza</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgTime">0s</div>
                <div class="stat-label">Tiempo Prom.</div>
            </div>
        </div>

        <!-- Estado -->
        <div id="statusContainer"></div>

        <!-- Progreso -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Inicializando...</div>
        </div>

        <!-- C√°mara/Canvas -->
        <div class="camera-container">
            <video id="video" autoplay muted playsinline style="display: none;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <div class="camera-overlay" id="cameraOverlay" style="display: none;">
                <div class="scan-frame"></div>
            </div>
        </div>

        <!-- Preview de imagen capturada -->
        <div class="image-preview" id="imagePreview">
            <img id="previewImg" alt="Imagen capturada">
        </div>

        <!-- Controles de C√°mara -->
        <div class="camera-controls">
            <button class="btn btn-primary" id="cameraBtn" onclick="toggleCamera()">
                üì∑ Iniciar C√°mara
            </button>
            <button class="btn btn-secondary" id="flipBtn" onclick="flipCamera()" disabled>
                üîÑ Cambiar C√°mara
            </button>
        </div>

        <button class="btn btn-success" id="captureBtn" onclick="captureAndProcess()" disabled>
            üì∏ Capturar y Procesar (Espacio)
        </button>

        <!-- √Årea de Texto -->
        <div id="textSection" style="display: none;">
            <label for="extractedText">Texto Extra√≠do:</label>
            <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
            </div>
            <textarea id="extractedText" class="text-area" placeholder="Texto extra√≠do aparecer√° aqu√≠..."></textarea>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <button class="btn btn-secondary" onclick="copyToClipboard()">
                    üìã Copiar
                </button>
                <button class="btn btn-secondary" onclick="retakePhoto()">
                    üîÑ Nueva Foto
                </button>
            </div>
        </div>

        <!-- Controles adicionales -->
        <div style="margin-top: 20px;">
            <button class="btn btn-secondary" onclick="toggleDebug()" style="margin-bottom: 10px;">
                üêõ Modo Debug
            </button>
        </div>

        <!-- Debug info -->
        <div class="debug-info" id="debugInfo"></div>

        <!-- Ayuda -->
        <div style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 12px; color: #718096;">
            <h4 style="color: #2d3748; margin-bottom: 8px;">‚å®Ô∏è Atajos:</h4>
            <p><strong>Espacio:</strong> Capturar y procesar | <strong>Escape:</strong> Nueva foto</p>
            
            <h4 style="color: #2d3748; margin: 15px 0 8px 0;">üí° Tips para mejor OCR:</h4>
            <p>‚Ä¢ Usa buena iluminaci√≥n uniforme</p>
            <p>‚Ä¢ Mant√©n el documento plano y sin arrugas</p>
            <p>‚Ä¢ Evita sombras y reflejos</p>
            <p>‚Ä¢ Coloca el texto en posici√≥n horizontal</p>
        </div>
    </div>

    <!-- Efecto Flash -->
    <div class="flash-effect" id="flashEffect"></div>

    <script>
        // Variables globales
        let video, canvas, ctx;
        let stream = null;
        let currentCamera = 'environment';
        let worker = null;
        let isProcessing = false;
        let debugMode = false;
        
        // Estad√≠sticas
        let stats = {
            processed: 0,
            confidenceSum: 0,
            timeSum: 0
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            initKeyboardShortcuts();
            checkTesseractAvailability();
        });

        function checkTesseractAvailability() {
            // Verificar peri√≥dicamente si Tesseract est√° disponible
            const checkInterval = setInterval(() => {
                if (typeof Tesseract !== 'undefined') {
                    clearInterval(checkInterval);
                    showStatus('success', '‚úÖ Tesseract.js cargado correctamente. Listo para usar.');
                    debugLog('Tesseract.js disponible');
                } else {
                    showStatus('info', '‚è≥ Cargando Tesseract.js...');
                }
            }, 500);

            // Timeout despu√©s de 10 segundos
            setTimeout(() => {
                if (typeof Tesseract === 'undefined') {
                    clearInterval(checkInterval);
                    showStatus('error', '‚ùå Error: Tesseract.js no se carg√≥. Verifica tu conexi√≥n a internet.');
                }
            }, 10000);
        }

        // Gesti√≥n de C√°mara
        async function toggleCamera() {
            const btn = document.getElementById('cameraBtn');
            
            if (stream) {
                stopCamera();
            } else {
                try {
                    await startCamera();
                } catch (error) {
                    showStatus('error', `Error al acceder a la c√°mara: ${error.message}`);
                }
            }
        }

        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Tu navegador no soporta acceso a la c√°mara');
                }

                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        frameRate: { ideal: 30 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Mostrar video y ocultar canvas
                video.style.display = 'block';
                canvas.style.display = 'none';
                document.getElementById('cameraOverlay').style.display = 'block';
                document.getElementById('imagePreview').style.display = 'none';
                
                document.getElementById('cameraBtn').textContent = '‚èπÔ∏è Detener C√°mara';
                document.getElementById('flipBtn').disabled = false;
                document.getElementById('captureBtn').disabled = false;
                
                showStatus('info', 'üì∑ C√°mara activa. Posiciona el documento y presiona capturar.');
                debugLog(`C√°mara iniciada: ${video.videoWidth}x${video.videoHeight}`);
                
            } catch (error) {
                let errorMessage = 'Error al acceder a la c√°mara';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso denegado. Permite el acceso a la c√°mara.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ c√°mara en el dispositivo.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'La c√°mara est√° siendo usada por otra aplicaci√≥n.';
                }
                
                throw new Error(errorMessage);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                
                video.style.display = 'none';
                document.getElementById('cameraOverlay').style.display = 'none';
                
                document.getElementById('cameraBtn').textContent = 'üì∑ Iniciar C√°mara';
                document.getElementById('flipBtn').disabled = true;
                document.getElementById('captureBtn').disabled = true;
                
                clearStatus();
            }
        }

        async function flipCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            
            if (stream) {
                stopCamera();
                await startCamera();
            }
        }

        // Captura y procesamiento OCR mejorado
        async function captureAndProcess() {
            if (!stream || isProcessing) return;

            if (typeof Tesseract === 'undefined') {
                showStatus('error', '‚ùå Tesseract.js no est√° disponible. Recarga la p√°gina.');
                return;
            }

            isProcessing = true;
            document.getElementById('captureBtn').disabled = true;

            try {
                // Efecto flash
                const flash = document.getElementById('flashEffect');
                flash.style.opacity = '0.8';
                setTimeout(() => flash.style.opacity = '0', 150);

                // Verificar dimensiones del video
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    throw new Error('El video no est√° listo. Espera un momento.');
                }

                debugLog(`Capturando imagen: ${video.videoWidth}x${video.videoHeight}`);

                // Capturar con m√°xima calidad
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(video, 0, 0);

                // Mostrar imagen capturada
                video.style.display = 'none';
                canvas.style.display = 'block';
                document.getElementById('cameraOverlay').style.display = 'none';
                
                // Mostrar preview
                const previewImg = document.getElementById('previewImg');
                previewImg.src = canvas.toDataURL('image/jpeg', 0.95);
                document.getElementById('imagePreview').style.display = 'block';

                // Procesar OCR
                await processOCRWithMaxPrecision();

            } catch (error) {
                console.error('Error en captura:', error);
                showStatus('error', `Error: ${error.message}`);
            } finally {
                isProcessing = false;
                document.getElementById('captureBtn').disabled = false;
            }
        }

        async function processOCRWithMaxPrecision() {
            const startTime = performance.now();
            
            showProgress(0, 'Preparando imagen...');
            
            try {
                // Inicializar worker si no existe
                if (!worker) {
                    showProgress(10, 'Inicializando OCR...');
                    await initializeOCRWorker();
                }

                // Preprocesar imagen para m√°xima precisi√≥n
                showProgress(30, 'Optimizando imagen...');
                const processedCanvas = await preprocessImageForOCR(canvas);
                
                showProgress(50, 'Extrayendo texto...');
                
                // Configuraci√≥n optimizada para m√°xima precisi√≥n
                const ocrOptions = {
                    tessedit_pageseg_mode: '1', // Automatic page segmentation with OSD
                    tessedit_ocr_engine_mode: '1', // Neural nets LSTM engine only
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,;:!?()[]{}"\'-/\\@#$%&*+=<>|~√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë ',
                    preserve_interword_spaces: '1',
                    textord_heavy_nr: '1'
                };

                // Procesar OCR con m√∫ltiples configuraciones para m√°xima precisi√≥n
                const results = await Promise.all([
                    worker.recognize(processedCanvas, ocrOptions),
                    worker.recognize(processedCanvas, { ...ocrOptions, tessedit_pageseg_mode: '6' }),
                    worker.recognize(processedCanvas, { ...ocrOptions, tessedit_pageseg_mode: '8' })
                ]);

                showProgress(90, 'Analizando resultados...');

                // Seleccionar el mejor resultado
                const bestResult = results.reduce((best, current) => {
                    const currentConfidence = current.data.confidence || 0;
                    const bestConfidence = best.data.confidence || 0;
                    return currentConfidence > bestConfidence ? current : best;
                });

                const rawText = bestResult.data.text || '';
                const confidence = bestResult.data.confidence || 0;

                // Post-procesar texto para corregir errores comunes
                const processedText = postProcessText(rawText);

                showProgress(100, 'Completado');
                hideProgress();

                // Mostrar resultados
                document.getElementById('extractedText').value = processedText;
                updateConfidence(confidence);
                document.getElementById('textSection').style.display = 'block';

                // Actualizar estad√≠sticas
                const processingTime = (performance.now() - startTime) / 1000;
                updateStats(confidence, processingTime);

                const message = `‚úÖ Texto extra√≠do con ${Math.round(confidence)}% confianza en ${processingTime.toFixed(1)}s`;
                showStatus('success', message);

                debugLog(`OCR completado: ${processedText.length} caracteres, ${confidence}% confianza`);

            } catch (error) {
                hideProgress();
                console.error('Error en OCR:', error);
                showStatus('error', `Error en OCR: ${error.message}`);
                debugLog(`Error OCR: ${error.toString()}`);
            }
        }

        async function initializeOCRWorker() {
            try {
                debugLog('Inicializando worker OCR...');
                
                worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = 50 + (m.progress * 40); // 50-90%
                            showProgress(progress, `Reconociendo texto: ${Math.round(m.progress * 100)}%`);
                        }
                        debugLog(`Tesseract: ${m.status} - ${m.progress || ''}`);
                    }
                });

                // Cargar idiomas para m√°xima cobertura
                await worker.loadLanguage('spa+eng');
                await worker.initialize('spa+eng');

                debugLog('Worker OCR inicializado correctamente');
                
            } catch (error) {
                debugLog(`Error inicializando worker: ${error.message}`);
                throw new Error(`Error al inicializar OCR: ${error.message}`);
            }
        }

        async function preprocessImageForOCR(sourceCanvas) {
            const processedCanvas = document.createElement('canvas');
            processedCanvas.width = sourceCanvas.width;
            processedCanvas.height = sourceCanvas.height;
            const processedCtx = processedCanvas.getContext('2d');

            // Aplicar filtros para mejorar la legibilidad
            processedCtx.filter = 'contrast(150%) brightness(110%) saturate(0%)';
            processedCtx.drawImage(sourceCanvas, 0, 0);

            // Aplicar procesamiento adicional pixel por pixel
            const imageData = processedCtx.getImageData(0, 0, processedCanvas.width, processedCanvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // Convertir a escala de grises
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                // Aplicar umbralizaci√≥n adaptativa
                const threshold = 128;
                const finalValue = gray > threshold ? 255 : 0;
                
                data[i] = finalValue;     // R
                data[i + 1] = finalValue; // G
                data[i + 2] = finalValue; // B
                // data[i + 3] permanece igual (alpha)
            }

            processedCtx.putImageData(imageData, 0, 0);
            debugLog('Imagen preprocesada para OCR');
            
            return processedCanvas;
        }

        function postProcessText(text) {
            if (!text) return '';

            let processed = text;

            // Eliminar l√≠neas vac√≠as m√∫ltiples
            processed = processed.replace(/\n\s*\n/g, '\n');

            // Corregir espacios m√∫ltiples
            processed = processed.replace(/\s+/g, ' ');

            // Correcciones comunes de OCR
            const corrections = {
                '0': 'O',  // En contexto de letras
                '1': 'I',  // En contexto de letras
                '5': 'S',  // En contexto de letras
                '8': 'B',  // En contexto de letras
                '|': 'I',
                '`': "'",
                '¬¥': "'",
                "'": "'",
                "'": "'",
                '"': '"',
                '"': '"'
            };

            // Aplicar correcciones solo en contexto apropiado
            Object.entries(corrections).forEach(([wrong, correct]) => {
                const regex = new RegExp(`([a-zA-Z√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë])${escapeRegex(wrong)}([a-zA-Z√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë])`, 'g');
                processed = processed.replace(regex, `$1${correct}$2`);
            });

            // Limpiar espacios al inicio y final
            processed = processed.trim();

            debugLog(`Texto post-procesado: ${text.length} -> ${processed.length} caracteres`);
            
            return processed;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Utilidades de interfaz
        function showProgress(percentage, text) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const textEl = document.getElementById('progressText');
            
            container.style.display = 'block';
            fill.style.width = percentage + '%';
            textEl.textContent = text;
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function updateConfidence(confidence) {
            const fill = document.getElementById('confidenceFill');
            const percentage = Math.round(confidence);
            fill.style.width = percentage + '%';
        }

        function updateStats(confidence, time) {
            stats.processed++;
            stats.confidenceSum += confidence;
            stats.timeSum += time;

            document.getElementById('docsProcessed').textContent = stats.processed;
            document.getElementById('avgConfidence').textContent = 
                Math.round(stats.confidenceSum / stats.processed) + '%';
            document.getElementById('avgTime').textContent = 
                (stats.timeSum / stats.processed).toFixed(1) + 's';
        }

        function copyToClipboard() {
            const text = document.getElementById('extractedText').value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showStatus('success', 'üìã Texto copiado al portapapeles');
                });
            } else {
                // Fallback para navegadores sin clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('success', 'üìã Texto copiado al portapapeles');
            }
        }

        function retakePhoto() {
            document.getElementById('textSection').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            
            if (stream) {
                video.style.display = 'block';
                canvas.style.display = 'none';
                document.getElementById('cameraOverlay').style.display = 'block';
            }
            
            document.getElementById('extractedText').value = '';
            updateConfidence(0);
            clearStatus();
        }

        // Sistema de notificaciones
        function showStatus(type, message) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `
                <div class="status status-${type}">
                    ${message}
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(clearStatus, 5000);
            }
            
            debugLog(`Status [${type}]: ${message}`);
        }

        function clearStatus() {
            document.getElementById('statusContainer').innerHTML = '';
        }

        // Debug
        function toggleDebug() {
            debugMode = !debugMode;
            const btn = event.target;
            const debugInfo = document.getElementById('debugInfo');
            
            if (debugMode) {
                btn.textContent = 'üêõ Debug: ON';
                btn.className = 'btn btn-success';
                debugInfo.style.display = 'block';
                showStatus('info', 'üêõ Modo debug activado');
            } else {
                btn.textContent = 'üêõ Modo Debug';
                btn.className = 'btn btn-secondary';
                debugInfo.style.display = 'none';
                debugInfo.innerHTML = '';
            }
        }

        function debugLog(message) {
            console.log('[DEBUG]', message);
            
            if (debugMode) {
                const debugInfo = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }

        // Atajos de teclado
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Evitar atajos cuando se est√° escribiendo en campos de texto
                if (e.target.matches('input, textarea')) return;
                
                // Espacio: Capturar y procesar
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (!document.getElementById('captureBtn').disabled && !isProcessing) {
                        captureAndProcess();
                    }
                }
                
                // Escape: Nueva foto
                if (e.key === 'Escape') {
                    e.preventDefault();
                    retakePhoto();
                }
                
                // Ctrl + C: Copiar texto
                if (e.ctrlKey && e.key === 'c' && document.getElementById('textSection').style.display !== 'none') {
                    copyToClipboard();
                }
            });
        }

        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            debugLog(`Error global: ${e.error?.message || e.message}`);
            
            if (!isProcessing) {
                showStatus('error', 'Se produjo un error inesperado. Revisa la consola.');
            }
        });

        // Limpieza al cerrar
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (worker) {
                worker.terminate();
            }
        });

        // Auto-reintentos para mejorar la precisi√≥n
        async function retryOCRWithDifferentSettings(canvas) {
            const retryConfigs = [
                { tessedit_pageseg_mode: '6', tessedit_ocr_engine_mode: '1' }, // Uniform text block
                { tessedit_pageseg_mode: '8', tessedit_ocr_engine_mode: '1' }, // Single word
                { tessedit_pageseg_mode: '7', tessedit_ocr_engine_mode: '1' }, // Single text line
                { tessedit_pageseg_mode: '13', tessedit_ocr_engine_mode: '1' } // Raw line
            ];

            let bestResult = null;
            let bestConfidence = 0;

            for (const config of retryConfigs) {
                try {
                    debugLog(`Probando configuraci√≥n: PSM ${config.tessedit_pageseg_mode}`);
                    const result = await worker.recognize(canvas, config);
                    const confidence = result.data.confidence || 0;
                    
                    if (confidence > bestConfidence) {
                        bestResult = result;
                        bestConfidence = confidence;
                    }
                } catch (error) {
                    debugLog(`Error con configuraci√≥n PSM ${config.tessedit_pageseg_mode}: ${error.message}`);
                }
            }

            return bestResult;
        }

        // Validaci√≥n de calidad de imagen
        function validateImageQuality(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let totalBrightness = 0;
            let pixels = 0;
            
            // Calcular brillo promedio
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                totalBrightness += brightness;
                pixels++;
            }
            
            const avgBrightness = totalBrightness / pixels;
            
            debugLog(`Calidad de imagen - Brillo promedio: ${avgBrightness.toFixed(1)}`);
            
            // Advertencias sobre calidad
            if (avgBrightness < 50) {
                showStatus('error', '‚ö†Ô∏è Imagen muy oscura. Mejora la iluminaci√≥n.');
                return false;
            } else if (avgBrightness > 200) {
                showStatus('error', '‚ö†Ô∏è Imagen muy clara. Reduce la exposici√≥n.');
                return false;
            }
            
            return true;
        }

        // Configuraci√≥n avanzada de Tesseract para m√°xima precisi√≥n
        function getOptimalOCRConfig() {
            return {
                tessedit_pageseg_mode: '1',
                tessedit_ocr_engine_mode: '1',
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,;:!?()[]{}"\'-/\\@#$%&*+=<>|~√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë ',
                preserve_interword_spaces: '1',
                textord_heavy_nr: '1',
                textord_min_linesize: '2.5',
                enable_noise_removal: '1',
                classify_enable_learning: '0',
                classify_enable_adaptive_matcher: '1',
                textord_really_old_xheight: '1',
                segment_penalty_dict_nonword: '1.25',
                segment_penalty_garbage: '1.50',
                language_model_penalty_non_freq_dict_word: '0.1',
                language_model_penalty_non_dict_word: '0.15'
            };
        }

        // Funci√≥n mejorada de procesamiento OCR
        async function processOCRWithMaxPrecision() {
            const startTime = performance.now();
            
            showProgress(0, 'Validando imagen...');
            
            try {
                // Validar calidad de imagen
                if (!validateImageQuality(canvas)) {
                    hideProgress();
                    return;
                }

                // Inicializar worker si no existe
                if (!worker) {
                    showProgress(10, 'Inicializando OCR avanzado...');
                    await initializeOCRWorker();
                }

                // Preprocesar imagen
                showProgress(30, 'Optimizando imagen...');
                const processedCanvas = await preprocessImageForOCR(canvas);
                
                showProgress(50, 'Extrayendo texto con m√°xima precisi√≥n...');
                
                // Usar configuraci√≥n √≥ptima
                const optimalConfig = getOptimalOCRConfig();
                
                // M√∫ltiples intentos con diferentes configuraciones
                const result = await retryOCRWithDifferentSettings(processedCanvas);
                
                if (!result) {
                    throw new Error('No se pudo extraer texto con ninguna configuraci√≥n');
                }

                showProgress(90, 'Refinando resultados...');

                const rawText = result.data.text || '';
                const confidence = result.data.confidence || 0;

                // Post-procesar texto
                const processedText = postProcessText(rawText);

                showProgress(100, 'Completado');
                hideProgress();

                // Mostrar resultados
                document.getElementById('extractedText').value = processedText;
                updateConfidence(confidence);
                document.getElementById('textSection').style.display = 'block';

                // Actualizar estad√≠sticas
                const processingTime = (performance.now() - startTime) / 1000;
                updateStats(confidence, processingTime);

                let statusMessage = `‚úÖ Texto extra√≠do: ${processedText.length} caracteres`;
                statusMessage += ` (${Math.round(confidence)}% confianza, ${processingTime.toFixed(1)}s)`;
                
                if (confidence >= 90) {
                    statusMessage = 'üéØ ' + statusMessage + ' - Excelente precisi√≥n!';
                } else if (confidence >= 70) {
                    statusMessage = 'üëç ' + statusMessage + ' - Buena precisi√≥n';
                } else {
                    statusMessage = '‚ö†Ô∏è ' + statusMessage + ' - Considera mejorar la imagen';
                }
                
                showStatus('success', statusMessage);

                debugLog(`OCR completado exitosamente: ${processedText.length} chars, ${confidence}% conf`);

            } catch (error) {
                hideProgress();
                console.error('Error en OCR:', error);
                showStatus('error', `‚ùå Error en OCR: ${error.message}`);
                debugLog(`Error OCR completo: ${error.toString()}`);
                
                // Intentar reinicializar el worker si fall√≥
                if (worker) {
                    try {
                        await worker.terminate();
                        worker = null;
                        debugLog('Worker reinicializado tras error');
                    } catch (termError) {
                        debugLog(`Error terminando worker: ${termError.message}`);
                    }
                }
            }
        }

        // Mensaje de bienvenida
        setTimeout(() => {
            if (typeof Tesseract !== 'undefined') {
                showStatus('info', 'üöÄ Sistema OCR listo. Inicia la c√°mara para comenzar.');
            }
        }, 2000);
    </script>
</body>
</html>