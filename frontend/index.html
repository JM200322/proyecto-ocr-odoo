<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta OCR para Odoo - OCR.Space API v3.0</title>
    
    <script>
        // Configuraci√≥n del backend - Detecci√≥n autom√°tica de URL
        function getBackendURL() {
            // Si estamos en el mismo dominio que el backend (despliegue en Render)
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                // Usar la misma URL del servidor actual
                const detectedURL = `${window.location.protocol}//${window.location.host}`;
                console.log('üåê Detecci√≥n autom√°tica de URL:', detectedURL);
                return detectedURL;
            }
            // Para desarrollo local
            console.log('üè† Modo desarrollo local detectado');
            return 'http://localhost:5000';
        }
        
        const BACKEND_URL = getBackendURL();
        console.log('üîó Backend URL configurada:', BACKEND_URL);
        
        // Funci√≥n para verificar conexi√≥n con el backend
        async function checkBackendConnection() {
            try {
                console.log('üîç Probando conexi√≥n con:', `${BACKEND_URL}/api/health`);
                
                const response = await fetch(`${BACKEND_URL}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('üìä Datos de respuesta:', data);
                
                if (data.success) {
                    console.log('‚úÖ Backend OCR.Space conectado correctamente');
                    return true;
                } else {
                    console.error('‚ùå Backend no disponible:', data);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error conectando con backend:', error);
                console.error('üîó URL intentada:', `${BACKEND_URL}/api/health`);
                console.error('üåê Hostname actual:', window.location.hostname);
                console.error('üì± User Agent:', navigator.userAgent);
                return false;
            }
        }
        
        // Verificar backend al cargar
        checkBackendConnection().then(connected => {
            if (!connected) {
                document.addEventListener('DOMContentLoaded', () => {
                    showStatus('error', '‚ùå Error: No se pudo conectar con el servidor OCR. Verifica que el backend est√© ejecut√°ndose.');
                });
            }
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2f855a;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #2d3748;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: #f7fafc;
            border-radius: 12px;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid #38a169;
            border-radius: 12px;
            background: rgba(56, 161, 105, 0.1);
        }

        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .status-info {
            background: #bee3f8;
            color: #2c5282;
            border: 2px solid #90cdf4;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .text-area {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 15px;
        }

        .text-area:focus {
            outline: none;
            border-color: #667eea;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #fc8181 0%, #f6e05e 50%, #68d391 100%);
            transition: width 0.3s;
        }

        .flash-effect {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .progress-container {
            background: #f7fafc;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #4a5568;
            margin-top: 5px;
        }

        .image-preview {
            display: none;
            margin: 15px 0;
        }

        .image-preview img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .document-type-indicator {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            color: #234e52;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                padding: 15px;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .camera-controls {
                grid-template-columns: 1fr;
            }
        }

        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #4a5568;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± OCR Ultra-Preciso v3.0</h1>
            <p>Extracci√≥n inteligente con OCR.Space API</p>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="docsProcessed">0</div>
                <div class="stat-label">Procesados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgConfidence">0%</div>
                <div class="stat-label">Confianza</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgTime">0s</div>
                <div class="stat-label">Tiempo Prom.</div>
            </div>
        </div>

        <!-- Estado -->
        <div id="statusContainer"></div>

        <!-- Indicador de tipo de documento -->
        <div class="document-type-indicator" id="documentTypeIndicator">
            üìÑ Tipo de documento: <span id="documentType">Analizando...</span>
        </div>

        <!-- Progreso -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Inicializando...</div>
        </div>

        <!-- C√°mara/Canvas -->
        <div class="camera-container">
            <video id="video" autoplay muted playsinline style="display: none;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <div class="camera-overlay" id="cameraOverlay" style="display: none;">
                <div class="scan-frame"></div>
            </div>
        </div>

        <!-- Preview de imagen capturada -->
        <div class="image-preview" id="imagePreview">
            <img id="previewImg" alt="Imagen capturada">
        </div>

        <!-- Controles de C√°mara -->
        <div class="camera-controls">
            <button class="btn btn-primary" id="cameraBtn" onclick="toggleCamera()">
                üì∑ Iniciar C√°mara
            </button>
            <button class="btn btn-secondary" id="flipBtn" onclick="flipCamera()" disabled>
                üîÑ Cambiar C√°mara
            </button>
        </div>

        <button class="btn btn-success" id="captureBtn" onclick="captureAndProcess()" disabled>
            üì∏ Capturar y Procesar (Espacio)
        </button>

        <!-- √Årea de Texto -->
        <div id="textSection" style="display: none;">
            <label for="extractedText">Texto Extra√≠do:</label>
            <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
            </div>
            <textarea id="extractedText" class="text-area" placeholder="Texto extra√≠do aparecer√° aqu√≠..."></textarea>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <button class="btn btn-secondary" onclick="copyToClipboard()">
                    üìã Copiar
                </button>
                <button class="btn btn-secondary" onclick="retakePhoto()">
                    üîÑ Nueva Foto
                </button>
            </div>
        </div>

        <!-- Controles adicionales -->
        <div style="margin-top: 20px;">
            <button class="btn btn-secondary" onclick="toggleDebug()" style="margin-bottom: 10px;">
                üêõ Modo Debug
            </button>
        </div>

        <!-- Debug info -->
        <div class="debug-info" id="debugInfo"></div>

        <!-- Ayuda -->
        <div style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 12px; color: #718096;">
            <h4 style="color: #2d3748; margin-bottom: 8px;">‚å®Ô∏è Atajos:</h4>
            <p><strong>Espacio:</strong> Capturar y procesar | <strong>Escape:</strong> Nueva foto</p>
            
            <h4 style="color: #2d3748; margin: 15px 0 8px 0;">üÜï Nuevas caracter√≠sticas v3.0:</h4>
            <p>‚Ä¢ OCR.Space API para m√°xima precisi√≥n</p>
            <p>‚Ä¢ Procesamiento en servidor optimizado</p>
            <p>‚Ä¢ Preprocesamiento avanzado de im√°genes</p>
            <p>‚Ä¢ M√∫ltiples motores OCR (engine 1, 2, 3)</p>
        </div>
    </div>

    <!-- Efecto Flash -->
    <div class="flash-effect" id="flashEffect"></div>

    <script>
        // Variables globales
        let video, canvas, ctx;
        let stream = null;
        let currentCamera = 'environment';
        let isProcessing = false;
        let debugMode = false;
        
        // Estad√≠sticas
        let stats = {
            processed: 0,
            confidenceSum: 0,
            timeSum: 0
        };











        // =====================================================
        // FUNCIONES PRINCIPALES MODIFICADAS
        // =====================================================

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            initKeyboardShortcuts();
            checkBackendAvailability();
        });

        function checkBackendAvailability() {
            const checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/health`);
                    const data = await response.json();
                    
                    if (data.success) {
                    clearInterval(checkInterval);
                        showStatus('success', '‚úÖ Backend OCR.Space conectado. Sistema OCR v3.0 listo.');
                        debugLog('Backend OCR.Space disponible - versi√≥n avanzada');
                } else {
                        showStatus('info', '‚è≥ Conectando con servidor OCR.Space...');
                }
                } catch (error) {
                    showStatus('info', '‚è≥ Conectando con servidor OCR.Space...');
                }
            }, 1000);

            setTimeout(() => {
                    clearInterval(checkInterval);
                showStatus('error', '‚ùå Error: No se pudo conectar con el servidor OCR. Verifica que el backend est√© ejecut√°ndose.');
            }, 10000);
        }

        // Gesti√≥n de C√°mara (sin cambios)
        async function toggleCamera() {
            const btn = document.getElementById('cameraBtn');
            
            if (stream) {
                stopCamera();
            } else {
                try {
                    await startCamera();
                } catch (error) {
                    showStatus('error', `Error al acceder a la c√°mara: ${error.message}`);
                }
            }
        }

        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Tu navegador no soporta acceso a la c√°mara');
                }

                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        frameRate: { ideal: 30 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.style.display = 'block';
                canvas.style.display = 'none';
                document.getElementById('cameraOverlay').style.display = 'block';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('documentTypeIndicator').style.display = 'none';
                
                document.getElementById('cameraBtn').textContent = '‚èπÔ∏è Detener C√°mara';
                document.getElementById('flipBtn').disabled = false;
                document.getElementById('captureBtn').disabled = false;
                
                showStatus('info', 'üì∑ C√°mara activa. Sistema OCR v3.0 preparado para an√°lisis con OCR.Space.');
                debugLog(`C√°mara iniciada: ${video.videoWidth}x${video.videoHeight}`);
                
            } catch (error) {
                let errorMessage = 'Error al acceder a la c√°mara';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso denegado. Permite el acceso a la c√°mara.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ c√°mara en el dispositivo.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'La c√°mara est√° siendo usada por otra aplicaci√≥n.';
                }
                
                throw new Error(errorMessage);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                
                video.style.display = 'none';
                document.getElementById('cameraOverlay').style.display = 'none';
                
                document.getElementById('cameraBtn').textContent = 'üì∑ Iniciar C√°mara';
                document.getElementById('flipBtn').disabled = true;
                document.getElementById('captureBtn').disabled = true;
                
                clearStatus();
            }
        }

        async function flipCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            
            if (stream) {
                stopCamera();
                await startCamera();
            }
        }

        // Captura y procesamiento OCR CON BACKEND
        async function captureAndProcess() {
            if (!stream || isProcessing) return;

            // Verificar conexi√≥n con backend
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();
                if (!data.success) {
                    showStatus('error', '‚ùå Servidor OCR no disponible. Verifica que el backend est√© ejecut√°ndose.');
                    return;
                }
            } catch (error) {
                showStatus('error', '‚ùå No se pudo conectar con el servidor OCR. Verifica la conexi√≥n.');
                return;
            }

            isProcessing = true;
            document.getElementById('captureBtn').disabled = true;

            try {
                // Efecto flash
                const flash = document.getElementById('flashEffect');
                flash.style.opacity = '0.8';
                setTimeout(() => flash.style.opacity = '0', 150);

                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    throw new Error('El video no est√° listo. Espera un momento.');
                }

                debugLog(`=== INICIANDO CAPTURA Y PROCESAMIENTO v2.0 ===`);
                debugLog(`Capturando imagen: ${video.videoWidth}x${video.videoHeight}`);

                // Capturar con m√°xima calidad
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(video, 0, 0);

                // Mostrar imagen capturada
                video.style.display = 'none';
                canvas.style.display = 'block';
                document.getElementById('cameraOverlay').style.display = 'none';
                
                // Mostrar preview
                const previewImg = document.getElementById('previewImg');
                previewImg.src = canvas.toDataURL('image/jpeg', 0.95);
                document.getElementById('imagePreview').style.display = 'block';

                // Procesar con sistema avanzado
                await processOCRWithAdvancedSystem();

            } catch (error) {
                console.error('Error en captura:', error);
                showStatus('error', `Error: ${error.message}`);
            } finally {
                isProcessing = false;
                document.getElementById('captureBtn').disabled = false;
            }
        }

        // FUNCI√ìN PRINCIPAL DE PROCESAMIENTO OCR CON BACKEND
        async function processOCRWithAdvancedSystem() {
            const startTime = performance.now();
            
            showProgress(0, 'Iniciando procesamiento con OCR.Space...');
            
            try {
                // PASO 1: Preparar imagen para env√≠o
                showProgress(10, 'Preparando imagen...');
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                
                // PASO 2: Enviar al backend
                showProgress(30, 'Enviando al servidor OCR.Space...');
                const response = await fetch(`${BACKEND_URL}/api/process-ocr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData,
                        brightness: 0,
                        contrast: 100,
                        sharpness: 0
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Error en el procesamiento OCR');
                }
                
                showProgress(90, 'Procesando resultados...');
                
                // PASO 3: Mostrar resultados
                const processedText = result.text || '';
                const confidence = result.confidence || 0;
                const processingTime = result.processing_time || 0;
                
                document.getElementById('extractedText').value = processedText;
                updateConfidence(confidence);
                document.getElementById('textSection').style.display = 'block';
                
                // Ocultar indicador de tipo de documento (no disponible en backend)
                document.getElementById('documentTypeIndicator').style.display = 'none';

                showProgress(100, 'Completado');
                hideProgress();

                // Actualizar estad√≠sticas
                updateStats(confidence, processingTime);

                // Mensaje de estado mejorado
                let statusMessage = `‚úÖ Texto extra√≠do: ${processedText.length} caracteres`;
                statusMessage += ` (${Math.round(confidence)}% confianza, ${processingTime.toFixed(1)}s)`;
                
                if (confidence >= 90) {
                    statusMessage = 'üéØ ' + statusMessage + ' - Excelente precisi√≥n!';
                } else if (confidence >= 70) {
                    statusMessage = 'üëç ' + statusMessage + ' - Buena precisi√≥n';
                } else {
                    statusMessage = '‚ö†Ô∏è ' + statusMessage + ' - Considera mejorar la imagen';
                }
                
                showStatus('success', statusMessage);
                debugLog(`=== PROCESAMIENTO COMPLETADO EXITOSAMENTE ===`);
                debugLog(`Detalles del procesamiento: ${JSON.stringify(result.details)}`);

            } catch (error) {
                hideProgress();
                console.error('Error en OCR con backend:', error);
                showStatus('error', `‚ùå Error en procesamiento: ${error.message}`);
                debugLog(`Error completo: ${error.toString()}`);
            }
        }



        function validateImageQuality(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let totalBrightness = 0;
            let pixels = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                totalBrightness += brightness;
                pixels++;
            }
            
            const avgBrightness = totalBrightness / pixels;
            
            debugLog(`Calidad de imagen - Brillo promedio: ${avgBrightness.toFixed(1)}`);
            
            if (avgBrightness < 50) {
                showStatus('error', '‚ö†Ô∏è Imagen muy oscura. Mejora la iluminaci√≥n para mejor OCR.');
                return false;
            } else if (avgBrightness > 200) {
                showStatus('error', '‚ö†Ô∏è Imagen muy clara. Reduce la exposici√≥n para mejor OCR.');
                return false;
            }
            
            return true;
        }

        // Utilidades de interfaz (sin cambios mayores)
        function showProgress(percentage, text) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const textEl = document.getElementById('progressText');
            
            container.style.display = 'block';
            fill.style.width = percentage + '%';
            textEl.textContent = text;
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function updateConfidence(confidence) {
            const fill = document.getElementById('confidenceFill');
            const percentage = Math.round(confidence);
            fill.style.width = percentage + '%';
        }

        function updateStats(confidence, time) {
            stats.processed++;
            stats.confidenceSum += confidence;
            stats.timeSum += time;

            document.getElementById('docsProcessed').textContent = stats.processed;
            document.getElementById('avgConfidence').textContent = 
                Math.round(stats.confidenceSum / stats.processed) + '%';
            document.getElementById('avgTime').textContent = 
                (stats.timeSum / stats.processed).toFixed(1) + 's';
        }

        function copyToClipboard() {
            const text = document.getElementById('extractedText').value;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showStatus('success', 'üìã Texto copiado al portapapeles');
                });
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('success', 'üìã Texto copiado al portapapeles');
            }
        }

        function retakePhoto() {
            document.getElementById('textSection').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('documentTypeIndicator').style.display = 'none';
            
            if (stream) {
                video.style.display = 'block';
                canvas.style.display = 'none';
                document.getElementById('cameraOverlay').style.display = 'block';
            }
            
            document.getElementById('extractedText').value = '';
            updateConfidence(0);
            clearStatus();
        }

        // Sistema de notificaciones
        function showStatus(type, message) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = `
                <div class="status status-${type}">
                    ${message}
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(clearStatus, 5000);
            }
            
            debugLog(`Status [${type}]: ${message}`);
        }

        function clearStatus() {
            document.getElementById('statusContainer').innerHTML = '';
        }

        // Debug
        function toggleDebug() {
            debugMode = !debugMode;
            const btn = event.target;
            const debugInfo = document.getElementById('debugInfo');
            
            if (debugMode) {
                btn.textContent = 'üêõ Debug: ON';
                btn.className = 'btn btn-success';
                debugInfo.style.display = 'block';
                showStatus('info', 'üêõ Modo debug activado - Sistema OCR v2.0');
            } else {
                btn.textContent = 'üêõ Modo Debug';
                btn.className = 'btn btn-secondary';
                debugInfo.style.display = 'none';
                debugInfo.innerHTML = '';
            }
        }

        function debugLog(message) {
            console.log('[DEBUG v2.0]', message);
            
            if (debugMode) {
                const debugInfo = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }

        // Atajos de teclado
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.matches('input, textarea')) return;
                
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (!document.getElementById('captureBtn').disabled && !isProcessing) {
                        captureAndProcess();
                    }
                }
                
                if (e.key === 'Escape') {
                    e.preventDefault();
                    retakePhoto();
                }
                
                if (e.ctrlKey && e.key === 'c' && document.getElementById('textSection').style.display !== 'none') {
                    copyToClipboard();
                }
                
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    toggleDebug();
                }
            });
        }

        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            debugLog(`Error global: ${e.error?.message || e.message}`);
            
            if (!isProcessing) {
                showStatus('error', 'Se produjo un error inesperado. Revisa la consola.');
            }
        });

        // Limpieza al cerrar
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (worker) {
                worker.terminate();
            }
        });



        // Mensaje de bienvenida mejorado
        setTimeout(async () => {
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();
                if (data.success) {
                    showStatus('info', 'üöÄ Sistema OCR v3.0 listo con OCR.Space API. Inicia la c√°mara para comenzar.');
                    debugLog('Sistema OCR v3.0 completamente inicializado');
                
                // Mostrar tip aleatorio
                const tips = [
                        'üí° Tip: El sistema usa OCR.Space API para m√°xima precisi√≥n',
                    'üí° Tip: Usa Ctrl+D para activar el modo debug avanzado', 
                        'üí° Tip: El preprocesamiento mejora autom√°ticamente la imagen'
                ];
                
                setTimeout(() => {
                    const randomTip = tips[Math.floor(Math.random() * tips.length)];
                    showStatus('info', randomTip);
                }, 3000);
                }
            } catch (error) {
                debugLog('Backend no disponible en mensaje de bienvenida');
            }
        }, 2000);

        // Auto-limpieza de datos antiguos
        function cleanupOldData() {
            // Limpiar m√©tricas antiguas
            const metrics = JSON.parse(localStorage.getItem('ocrMetrics') || '[]');
            
            // Mantener solo las √∫ltimas 50 m√©tricas
            if (metrics.length > 50) {
                const recentMetrics = metrics.slice(-50);
                localStorage.setItem('ocrMetrics', JSON.stringify(recentMetrics));
            }
        }

        // Ejecutar limpieza al cargar
        cleanupOldData();

        debugLog('=== SISTEMA OCR v3.0 INICIALIZADO ===');
        debugLog('Caracter√≠sticas habilitadas:');
        debugLog('- OCR.Space API para m√°xima precisi√≥n');
        debugLog('- Procesamiento en servidor optimizado');
        debugLog('- Preprocesamiento avanzado de imagen');
        debugLog('- M√∫ltiples motores OCR (engine 1, 2, 3)');
        debugLog('- Post-procesamiento inteligente');
        debugLog('- An√°lisis de calidad de imagen');
        debugLog('- M√©tricas de rendimiento');
        debugLog('=====================================');
    </script>
</body>
</html>